{"ast":null,"code":"\"use strict\";\n\n/**\n * @file Price Feed\n * @desc These methods facilitate interactions with the Open Price Feed smart\n *     contracts.\n */\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n      label: 0,\n      sent: function () {\n        if (t[0] & 1) throw t[1];\n        return t[1];\n      },\n      trys: [],\n      ops: []\n    },\n    f,\n    y,\n    t,\n    g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n        case 7:\n          op = _.ops.pop();\n          _.trys.pop();\n          continue;\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n            _.ops.push(op);\n            break;\n          }\n          if (t[2]) _.ops.pop();\n          _.trys.pop();\n          continue;\n      }\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\nexports.__esModule = true;\nexports.getPrice = void 0;\nvar eth = require(\"./eth\");\nvar helpers_1 = require(\"./helpers\");\nvar constants_1 = require(\"./constants\");\nfunction validateAsset(asset, argument, errorPrefix) {\n  if (typeof asset !== 'string' || asset.length < 1) {\n    throw Error(errorPrefix + 'Argument `' + argument + '` must be a non-empty string.');\n  }\n  var assetIsCToken = asset[0] === 'c';\n  var cTokenName = assetIsCToken ? asset : 'c' + asset;\n  var cTokenAddress = constants_1.address[this._network.name][cTokenName];\n  var underlyingName = assetIsCToken ? asset.slice(1, asset.length) : asset;\n  var underlyingAddress = constants_1.address[this._network.name][underlyingName];\n  if ((!constants_1.cTokens.includes(cTokenName) || !constants_1.underlyings.includes(underlyingName)) && !constants_1.opfAssets.includes(underlyingName)) {\n    throw Error(errorPrefix + 'Argument `' + argument + '` is not supported.');\n  }\n  var underlyingDecimals = constants_1.decimals[underlyingName];\n  // The open price feed reveals BTC, not WBTC.\n  underlyingName = underlyingName === 'WBTC' ? 'BTC' : underlyingName;\n  return [assetIsCToken, cTokenName, cTokenAddress, underlyingName, underlyingAddress, underlyingDecimals];\n}\nfunction cTokenExchangeRate(cTokenAddress, cTokenName, underlyingDecimals) {\n  return __awaiter(this, void 0, void 0, function () {\n    var address, method, options, exchangeRateCurrent, mantissa, oneCTokenInUnderlying;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          address = cTokenAddress;\n          method = 'exchangeRateCurrent';\n          options = {\n            _compoundProvider: this._provider,\n            abi: cTokenName === constants_1.constants.cETH ? constants_1.abi.cEther : constants_1.abi.cErc20\n          };\n          return [4 /*yield*/, eth.read(address, method, [], options)];\n        case 1:\n          exchangeRateCurrent = _a.sent();\n          mantissa = 18 + underlyingDecimals - 8;\n          oneCTokenInUnderlying = exchangeRateCurrent / Math.pow(10, mantissa);\n          return [2 /*return*/, oneCTokenInUnderlying];\n      }\n    });\n  });\n}\n/**\n * Gets an asset's price from the Compound Protocol open price feed. The price\n *    of the asset can be returned in any other supported asset value, including\n *    all cTokens and underlyings.\n *\n * @param {string} asset A string of a supported asset in which to find the\n *     current price.\n * @param {string} [inAsset] A string of a supported asset in which to express\n *     the `asset` parameter's price. This defaults to USD.\n *\n * @returns {string} Returns a string of the numeric value of the asset.\n *\n * @example\n * ```\n * const compound = new Compound(window.ethereum);\n * let price;\n *\n * (async function () {\n *\n *   price = await compound.getPrice(Compound.WBTC);\n *   console.log('WBTC in USD', price); // 6 decimals, see Open Price Feed docs\n *\n *   price = await compound.getPrice(Compound.BAT, Compound.USDC); // supports cTokens too\n *   console.log('BAT in USDC', price);\n *\n * })().catch(console.error);\n * ```\n */\nfunction getPrice(asset, inAsset) {\n  if (inAsset === void 0) {\n    inAsset = constants_1.constants.USDC;\n  }\n  return __awaiter(this, void 0, void 0, function () {\n    var errorPrefix, _a,\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n      assetIsCToken, cTokenName, cTokenAddress, underlyingName, underlyingAddress, underlyingDecimals, _b,\n      // eslint-disable-next-line @typescript-eslint/no-unused-vars\n      inAssetIsCToken, inAssetCTokenName, inAssetCTokenAddress, inAssetUnderlyingName, inAssetUnderlyingAddress, inAssetUnderlyingDecimals, priceFeedAddress, trxOptions, assetUnderlyingPrice, inAssetUnderlyingPrice, assetCTokensInUnderlying, inAssetCTokensInUnderlying, result, assetInOther, assetInOther, assetInOther, cTokensInUnderlying;\n    return __generator(this, function (_c) {\n      switch (_c.label) {\n        case 0:\n          return [4 /*yield*/, helpers_1.netId(this)];\n        case 1:\n          _c.sent();\n          errorPrefix = 'Compound [getPrice] | ';\n          _a = validateAsset.bind(this)(asset, 'asset', errorPrefix), assetIsCToken = _a[0], cTokenName = _a[1], cTokenAddress = _a[2], underlyingName = _a[3], underlyingAddress = _a[4], underlyingDecimals = _a[5];\n          _b = validateAsset.bind(this)(inAsset, 'inAsset', errorPrefix), inAssetIsCToken = _b[0], inAssetCTokenName = _b[1], inAssetCTokenAddress = _b[2], inAssetUnderlyingName = _b[3], inAssetUnderlyingAddress = _b[4], inAssetUnderlyingDecimals = _b[5];\n          priceFeedAddress = constants_1.address[this._network.name].PriceFeed;\n          trxOptions = {\n            _compoundProvider: this._provider,\n            abi: constants_1.abi.PriceFeed\n          };\n          return [4 /*yield*/, eth.read(priceFeedAddress, 'price', [underlyingName], trxOptions)];\n        case 2:\n          assetUnderlyingPrice = _c.sent();\n          return [4 /*yield*/, eth.read(priceFeedAddress, 'price', [inAssetUnderlyingName], trxOptions)];\n        case 3:\n          inAssetUnderlyingPrice = _c.sent();\n          if (!assetIsCToken) return [3 /*break*/, 5];\n          return [4 /*yield*/, cTokenExchangeRate.bind(this)(cTokenAddress, cTokenName, underlyingDecimals)];\n        case 4:\n          assetCTokensInUnderlying = _c.sent();\n          _c.label = 5;\n        case 5:\n          if (!inAssetIsCToken) return [3 /*break*/, 7];\n          return [4 /*yield*/, cTokenExchangeRate.bind(this)(inAssetCTokenAddress, inAssetCTokenName, inAssetUnderlyingDecimals)];\n        case 6:\n          inAssetCTokensInUnderlying = _c.sent();\n          _c.label = 7;\n        case 7:\n          if (!assetIsCToken && !inAssetIsCToken) {\n            result = assetUnderlyingPrice / inAssetUnderlyingPrice;\n          } else if (assetIsCToken && !inAssetIsCToken) {\n            assetInOther = assetUnderlyingPrice / inAssetUnderlyingPrice;\n            result = assetInOther * assetCTokensInUnderlying;\n          } else if (!assetIsCToken && inAssetIsCToken) {\n            assetInOther = assetUnderlyingPrice / inAssetUnderlyingPrice;\n            result = assetInOther / inAssetCTokensInUnderlying;\n          } else {\n            assetInOther = assetUnderlyingPrice / inAssetUnderlyingPrice;\n            cTokensInUnderlying = assetInOther / assetCTokensInUnderlying;\n            result = inAssetCTokensInUnderlying * cTokensInUnderlying;\n          }\n          return [2 /*return*/, result];\n      }\n    });\n  });\n}\nexports.getPrice = getPrice;","map":{"version":3,"names":["eth","require","helpers_1","constants_1","validateAsset","asset","argument","errorPrefix","length","Error","assetIsCToken","cTokenName","cTokenAddress","address","_network","name","underlyingName","slice","underlyingAddress","cTokens","includes","underlyings","opfAssets","underlyingDecimals","decimals","cTokenExchangeRate","method","options","_compoundProvider","_provider","abi","constants","cETH","cEther","cErc20","read","exchangeRateCurrent","_a","sent","mantissa","oneCTokenInUnderlying","Math","pow","getPrice","inAsset","USDC","netId","_c","bind","_b","inAssetIsCToken","inAssetCTokenName","inAssetCTokenAddress","inAssetUnderlyingName","inAssetUnderlyingAddress","inAssetUnderlyingDecimals","priceFeedAddress","PriceFeed","trxOptions","assetUnderlyingPrice","inAssetUnderlyingPrice","assetCTokensInUnderlying","inAssetCTokensInUnderlying","result","assetInOther","cTokensInUnderlying","exports"],"sources":["../../src/priceFeed.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}