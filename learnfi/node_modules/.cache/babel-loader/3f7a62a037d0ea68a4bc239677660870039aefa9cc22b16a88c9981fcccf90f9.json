{"ast":null,"code":"\"use strict\";\n\n// Based on\n// https://github.com/ethereum/EIPs/blob/master/assets/eip-712/Example.js\nvar __awaiter = this && this.__awaiter || function (thisArg, _arguments, P, generator) {\n  function adopt(value) {\n    return value instanceof P ? value : new P(function (resolve) {\n      resolve(value);\n    });\n  }\n  return new (P || (P = Promise))(function (resolve, reject) {\n    function fulfilled(value) {\n      try {\n        step(generator.next(value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function rejected(value) {\n      try {\n        step(generator[\"throw\"](value));\n      } catch (e) {\n        reject(e);\n      }\n    }\n    function step(result) {\n      result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected);\n    }\n    step((generator = generator.apply(thisArg, _arguments || [])).next());\n  });\n};\nvar __generator = this && this.__generator || function (thisArg, body) {\n  var _ = {\n      label: 0,\n      sent: function () {\n        if (t[0] & 1) throw t[1];\n        return t[1];\n      },\n      trys: [],\n      ops: []\n    },\n    f,\n    y,\n    t,\n    g;\n  return g = {\n    next: verb(0),\n    \"throw\": verb(1),\n    \"return\": verb(2)\n  }, typeof Symbol === \"function\" && (g[Symbol.iterator] = function () {\n    return this;\n  }), g;\n  function verb(n) {\n    return function (v) {\n      return step([n, v]);\n    };\n  }\n  function step(op) {\n    if (f) throw new TypeError(\"Generator is already executing.\");\n    while (_) try {\n      if (f = 1, y && (t = op[0] & 2 ? y[\"return\"] : op[0] ? y[\"throw\"] || ((t = y[\"return\"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;\n      if (y = 0, t) op = [op[0] & 2, t.value];\n      switch (op[0]) {\n        case 0:\n        case 1:\n          t = op;\n          break;\n        case 4:\n          _.label++;\n          return {\n            value: op[1],\n            done: false\n          };\n        case 5:\n          _.label++;\n          y = op[1];\n          op = [0];\n          continue;\n        case 7:\n          op = _.ops.pop();\n          _.trys.pop();\n          continue;\n        default:\n          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {\n            _ = 0;\n            continue;\n          }\n          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {\n            _.label = op[1];\n            break;\n          }\n          if (op[0] === 6 && _.label < t[1]) {\n            _.label = t[1];\n            t = op;\n            break;\n          }\n          if (t && _.label < t[2]) {\n            _.label = t[2];\n            _.ops.push(op);\n            break;\n          }\n          if (t[2]) _.ops.pop();\n          _.trys.pop();\n          continue;\n      }\n      op = body.call(thisArg, _);\n    } catch (e) {\n      op = [6, e];\n      y = 0;\n    } finally {\n      f = t = 0;\n    }\n    if (op[0] & 5) throw op[1];\n    return {\n      value: op[0] ? op[1] : void 0,\n      done: true\n    };\n  }\n};\nexports.__esModule = true;\nexports.sign = void 0;\nvar ethers_1 = require(\"ethers\");\nfunction abiRawEncode(encTypes, encValues) {\n  var hexStr = ethers_1.ethers.utils.defaultAbiCoder.encode(encTypes, encValues);\n  return Buffer.from(hexStr.slice(2, hexStr.length), 'hex');\n}\nfunction keccak256(arg) {\n  var hexStr = ethers_1.ethers.utils.keccak256(arg);\n  return Buffer.from(hexStr.slice(2, hexStr.length), 'hex');\n}\n// Recursively finds all the dependencies of a type\nfunction dependencies(primaryType, found, types) {\n  if (found === void 0) {\n    found = [];\n  }\n  if (types === void 0) {\n    types = {};\n  }\n  if (found.includes(primaryType)) {\n    return found;\n  }\n  if (types[primaryType] === undefined) {\n    return found;\n  }\n  found.push(primaryType);\n  for (var _i = 0, _a = types[primaryType]; _i < _a.length; _i++) {\n    var field = _a[_i];\n    for (var _b = 0, _c = dependencies(field.type, found); _b < _c.length; _b++) {\n      var dep = _c[_b];\n      if (!found.includes(dep)) {\n        found.push(dep);\n      }\n    }\n  }\n  return found;\n}\nfunction encodeType(primaryType, types) {\n  if (types === void 0) {\n    types = {};\n  }\n  // Get dependencies primary first, then alphabetical\n  var deps = dependencies(primaryType);\n  deps = deps.filter(function (t) {\n    return t != primaryType;\n  });\n  deps = [primaryType].concat(deps.sort());\n  // Format as a string with fields\n  var result = '';\n  for (var _i = 0, deps_1 = deps; _i < deps_1.length; _i++) {\n    var type = deps_1[_i];\n    if (!types[type]) throw new Error(\"Type '\" + type + \"' not defined in types (\" + JSON.stringify(types) + \")\");\n    result += type + \"(\" + types[type].map(function (_a) {\n      var name = _a.name,\n        type = _a.type;\n      return type + \" \" + name;\n    }).join(',') + \")\";\n  }\n  return result;\n}\nfunction typeHash(primaryType, types) {\n  if (types === void 0) {\n    types = {};\n  }\n  return keccak256(Buffer.from(encodeType(primaryType, types)));\n}\nfunction encodeData(primaryType, data, types) {\n  if (types === void 0) {\n    types = {};\n  }\n  var encTypes = [];\n  var encValues = [];\n  // Add typehash\n  encTypes.push('bytes32');\n  encValues.push(typeHash(primaryType, types));\n  // Add field contents\n  for (var _i = 0, _a = types[primaryType]; _i < _a.length; _i++) {\n    var field = _a[_i];\n    var value = data[field.name];\n    if (field.type == 'string' || field.type == 'bytes') {\n      encTypes.push('bytes32');\n      value = keccak256(Buffer.from(value));\n      encValues.push(value);\n    } else if (types[field.type] !== undefined) {\n      encTypes.push('bytes32');\n      value = keccak256(encodeData(field.type, value, types));\n      encValues.push(value);\n    } else if (field.type.lastIndexOf(']') === field.type.length - 1) {\n      throw 'TODO: Arrays currently unimplemented in encodeData';\n    } else {\n      encTypes.push(field.type);\n      encValues.push(value);\n    }\n  }\n  return abiRawEncode(encTypes, encValues);\n}\nfunction domainSeparator(domain) {\n  var types = {\n    EIP712Domain: [{\n      name: 'name',\n      type: 'string'\n    }, {\n      name: 'version',\n      type: 'string'\n    }, {\n      name: 'chainId',\n      type: 'uint256'\n    }, {\n      name: 'verifyingContract',\n      type: 'address'\n    }, {\n      name: 'salt',\n      type: 'bytes32'\n    }].filter(function (a) {\n      return domain[a.name];\n    })\n  };\n  return keccak256(encodeData('EIP712Domain', domain, types));\n}\nfunction structHash(primaryType, data, types) {\n  if (types === void 0) {\n    types = {};\n  }\n  return keccak256(encodeData(primaryType, data, types));\n}\nfunction digestToSign(domain, primaryType, message, types) {\n  if (types === void 0) {\n    types = {};\n  }\n  return keccak256(Buffer.concat([Buffer.from('1901', 'hex'), domainSeparator(domain), structHash(primaryType, message, types)]));\n}\nfunction sign(domain, primaryType, message, types, signer) {\n  return __awaiter(this, void 0, void 0, function () {\n    var signature, digest, address, msgParams, r, s, v, e_1;\n    return __generator(this, function (_a) {\n      switch (_a.label) {\n        case 0:\n          _a.trys.push([0, 5,, 6]);\n          if (!signer._signingKey) return [3 /*break*/, 1];\n          digest = digestToSign(domain, primaryType, message, types);\n          signature = signer._signingKey().signDigest(digest);\n          signature.v = '0x' + signature.v.toString(16);\n          return [3 /*break*/, 4];\n        case 1:\n          return [4 /*yield*/, signer.getAddress()];\n        case 2:\n          address = _a.sent();\n          msgParams = JSON.stringify({\n            domain: domain,\n            primaryType: primaryType,\n            message: message,\n            types: types\n          });\n          return [4 /*yield*/, signer.provider.jsonRpcFetchFunc('eth_signTypedData_v4', [address, msgParams])];\n        case 3:\n          signature = _a.sent();\n          r = '0x' + signature.substring(2).substring(0, 64);\n          s = '0x' + signature.substring(2).substring(64, 128);\n          v = '0x' + signature.substring(2).substring(128, 130);\n          signature = {\n            r: r,\n            s: s,\n            v: v\n          };\n          _a.label = 4;\n        case 4:\n          return [3 /*break*/, 6];\n        case 5:\n          e_1 = _a.sent();\n          throw new Error(e_1);\n        case 6:\n          return [2 /*return*/, signature];\n      }\n    });\n  });\n}\nexports.sign = sign;","map":{"version":3,"names":["ethers_1","require","abiRawEncode","encTypes","encValues","hexStr","ethers","utils","defaultAbiCoder","encode","Buffer","from","slice","length","keccak256","arg","dependencies","primaryType","found","types","includes","undefined","push","_i","_a","field","_b","_c","type","dep","encodeType","deps","filter","t","concat","sort","result","deps_1","Error","JSON","stringify","map","name","join","typeHash","encodeData","data","value","lastIndexOf","domainSeparator","domain","EIP712Domain","a","structHash","digestToSign","message","sign","signer","_signingKey","digest","signature","signDigest","v","toString","getAddress","address","sent","msgParams","provider","jsonRpcFetchFunc","r","substring","s","e_1","exports"],"sources":["../../src/EIP712.ts"],"sourcesContent":[null],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"script","externalDependencies":[]}